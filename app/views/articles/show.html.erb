<%# Anki Books, a note-taking app to organize knowledge, %>
<%# is licensed under the GNU Affero General Public License, version 3 %>
<%# Copyright (C) 2023 Kyle Rego %>

<section class="article-section w-full break-anywhere" data-controller="set-top-under-nav">
  <div class="position-sticky z-50 bg-white article-nav" data-set-top-under-nav-target="element">
    <%= link_to("#{@book.title}", book_articles_path(@book), class: "mr-4") if @book %>
    <%= link_to("#{@article.title}", article_path(@article), class: "mr-4") %>
    <% if logged_in? %>
      <%= link_to("Edit article", edit_article_path(@article), class: "action mr-4") %>
      <%= link_to("Manage article", manage_article_path(@article), class: "action mr-4") %>
    <% end %>
    <% if @article.basic_notes.any? %>
      <%= link_to("Study cards", study_article_cards_path_helper(article: @article), class: "action") %>
    <% end %>
  </div>

  <div class="flex flex-row sm-flex-col" data-controller="article-notes-position-setter">
    <div class="min-w-2-3 flex-grow-2" data-article-notes-position-setter-target="content">
      <%= @article.content_without_cloze_markers %>
    </div>
    <% if logged_in? || @basic_notes.any? || @cloze_notes.any? %>
      <%# The id attribute here is used to POST the right article_id param to articles#change_note_ordinal_position %>
      <%# The divs with class reorderable-basic-note-unit must be direct children of this container %>
      <div id="article-notes-<%= @article.id %>" data-article-notes-position-setter-target="notes"
          class="position-sticky sm-position-static overflow-y-auto sm-overflow-y-scroll
                  min-w-1-3 flex-grow-1 ml-1
                  reorderable-basic-note-units-container flex flex-col justify-start">

        <% if logged_in? && !@use_book_version %>
          <%= render "articles/basic_note/first_new_basic_note_link" %>
        <% end %>

        <% @basic_notes&.each do |basic_note| %>
          <% @basic_note = basic_note %>
          <% if @use_book_version %>
            <%= render partial: "books/basic_note/show" %>
          <% else %>
            <%= render partial: "articles/basic_note/show" %>
          <% end %>
        <% end %>

        <% if logged_in? %>
          <%= render partial: "articles/cloze_note/new_cloze_note_link" %>
        <% end %>

        <% @cloze_notes&.each do |cloze_note| %>
          <% @cloze_note = cloze_note %>
          <%= render partial: "articles/cloze_note/show" %>
        <% end %>
      </div>
    <% end %>
  </div>
</section>
